
@model WebSaludOcupacional.Models.ReportesModel.Liquidacion

@{
    ViewBag.Title = "Reporte de devoluciones";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Scripts.Render("~/bundles/jqueryval")
@Styles.Render("~/Content/DateRangePickerCss")
@Scripts.Render("~/Script/DateRangePickerJs")

<div class="row" role="main">
    @using (Html.BeginForm("Liquidacion", "Reportes", FormMethod.Post, new { @name = "frmLiquidacion", @id = "frmLiquidacion" }))
    {
        @Html.AntiForgeryToken()
        <h3 class="letra-marron"><i class="fa fa-area-chart"></i> Reporte de devoluciones</h3>
        <hr />
        <div class="form-horizontal">
            <div class="form-group">                
                <label for="ddlCentros" class="col-xs-2 col-md-1 control-label letra-marron">Centro : </label>
                <div class="col-xs-4 col-md-2">
                    <div class="input-group">
                        <span class="input-group-addon contenido-rojo"><span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span></span>
                        @Html.DropDownListFor(m => m.IdCentro, new SelectList(Model.Centros, "IdCentro", "Nombre"), new { @class = "form-control" })
                    </div>
                </div>
                <label class="control-label col-xs-2 col-md-2 letra-marron" for="dpFecha">Rango de fechas : </label>
                <div class="col-md-3">
                    <div class="input-group">
                        <span class="input-group-addon contenido-rojo"><span class="glyphicon glyphicon-calendar"></span></span>
                        @Html.TextBoxFor(x => x.FchRangos, new { @class = "form-control", @id = "dpFecha" })
                    </div>
                </div>
                <div class="col-xs-2 col-md-2">
                    <button class="btn btn-danger custom-btn" type="submit"><i class="fa fa-search"></i> Buscar</button>
                </div>
                <div class="col-xs-2 col-md-2">
                    <button class="btn btn-danger custom-btn" type="button" id="btnExcel"><i class="fa fa-file-excel-o"></i> Exportar&nbsp;</button>
                </div>        
            </div>
        </div>
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="col-md-12">
            <table class="table table-hover" id="tbBusqueda">
                <thead>
                    <tr>
                        <th class="contenido-rojo">Fecha<br />Inicio</th>
                        <th class="contenido-rojo">Fecha<br />Final</th>
                        <th class="contenido-rojo">Hora<br />Inicio</th>
                        <th class="contenido-rojo">Hora<br />Final</th>
                        <th class="contenido-rojo">Centro</th>
                        <th class="contenido-rojo">Nro. Guía</th>
                        <th class="contenido-rojo">Fecha Entrega</th>
                        <th class="contenido-rojo">Placa</th>
                        <th class="contenido-rojo">Transportista</th>
                        <th class="contenido-rojo">T.Reg.</th>
                        <th class="contenido-rojo">Inspector</th>                        
                        <th class="contenido-rojo">T.Ins.</th>
                        <th class="contenido-rojo">T.Esp.</th>
                        <th class="contenido-rojo"></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in Model.Busqueda)
                    {
                        <tr class="odd">
                            <td class="letra-marron">@r.FechaInicio.ToString("dd/MM/yyyy")</td>
                            <td class="letra-marron">@r.FechaFinal.ToString("dd/MM/yyyy")</td>
                            <td class="letra-marron">@r.FechaInicio.ToString("HH:mm")</td>
                            <td class="letra-marron">@r.FechaFinal.ToString("HH:mm")</td>
                            <td class="letra-marron">@r.Centro</td>
                            <td class="letra-marron">@r.NumeroGuia</td>
                            <td class="letra-marron">@DateTime.ParseExact(r.FechaEntrega, "yyyyMMdd", System.Globalization.CultureInfo.InvariantCulture).ToString("dd/MM/yyyy") </td>
                            <td class="letra-marron">@r.Vehiculo</td>
                            <td class="letra-marron">@r.Transportista</td>
                            <td class="letra-marron">@String.Format("{0:n}", r.TiempoRegistro)</td>
                            <td class="letra-marron">@r.Inspector</td>                            
                            <td class="letra-marron">@String.Format("{0:n}", r.TiempoInspeccion)</td>
                            <td class="letra-marron">@String.Format("{0:n}", r.TiempoEspera)</td>
                            <td class="letra-marron">
                                <button type="button" class="btn btn-danger btn-xs custom-btn details"
                                        data-targeturl="@Url.Action("Detalle", "Reportes", new { id = r.IdOrdenCarga })">
                                    <i class="fa fa-list-alt"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<!-- Modal -->
<div id="modal-container" class="modal fade" tabindex="-1" role="dialog" style="overflow-y:auto;">
   
</div>

<script type="text/javascript">
    if (typeof NProgress != 'undefined') {
        NProgress.set(0.3)
        $(document).ready(function () {
            NProgress.done();
        });
    }

    var table = '';
    $(document).ready(function () {

        $('#dpFecha').daterangepicker({
            "autoApply": true,
            locale: 'es'
        });

        table = $('#tbBusqueda').DataTable({
            'paging': false
        });

        $('#btnExcel').click(function () {
            var fecha = $('#dpFecha').val().split(' - ');
            var fechaInicio = '' + fecha[0].split('/')[2] + fecha[0].split('/')[1] + fecha[0].split('/')[0];
            var fechaFinal = '' + fecha[1].split('/')[2] + fecha[1].split('/')[1] + fecha[1].split('/')[0];

            var url = "http://JRINCIDENCIASP.jrdomain.incakola.com.pe/MegaCentroAPI/api/OrdenCarga/DescargarConsultarInspeccion/" +
                fechaInicio + "/" + fechaFinal + "/" + @Model.IdCentro;

            $.ajax({
                type: 'GET',
                url: url,
                contentType: 'application/vnd.ms-excel',
                dataType: 'text',
                success: function () {
                    window.location = url;
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    window.location = url;
                }
            });
        });
    });

    $(".details").on('click', function (e) {
        console.log('click');
        e.preventDefault();
        $("#modal-container").remove();
        $.get($(this).data("targeturl"), function (data) {
            $('<div id="modal-container" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" style="overflow-y:auto;" >' +
                '<div class="modal-dialog modal-lg" role="document">' +
                    '<div class="modal-content" id= "modalbody" >' +
                        data + '</div></div>').modal('show');
        });
    });

</script>   